var ImageOrientationFix=function(opts){var settings={image:"",imgType:"url",onFix:function(base64ImgStr){}};var _exifInfo={};var _realImage="";$.extend(settings,opts);function detectVerticalSquash(img){var iw=img.naturalWidth,ih=img.naturalHeight;var canvas=document.createElement("canvas");canvas.width=1;canvas.height=ih;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);var data=ctx.getImageData(0,0,1,ih).data;var sy=0;var ey=ih;var py=ih;while(py>sy){var alpha=data[(py-1)*4+3];if(alpha===0){ey=py}else{sy=py}py=ey+sy>>1}var ratio=py/ih;return ratio===0?1:ratio}function drawImageIOSFix(ctx,img,sx,sy,sw,sh,dx,dy,dw,dh){var vertSquashRatio=detectVerticalSquash(img);ctx.drawImage(img,sx*vertSquashRatio,sy*vertSquashRatio,sw*vertSquashRatio,sh*vertSquashRatio,dx,dy,dw,dh)}var _app={init:function(){var __image=new Image;var _me=this;_realImage=__image;__image.onload=function(){EXIF.getData(this,function(){_exifInfo=EXIF.getAllTags(this);_me.__fix()})};if(settings.imgType=="image"){__image.src=$(settings.image).attr("src")}else{__image.src=settings.image}},__fix:function(){var Options={width:_realImage.naturalWidth,height:_realImage.naturalHeight,transX:0,transY:0,XDimension:0,YDimension:0,Orientation:1};Options.Orientation=_exifInfo.Orientation;if(Options.Orientation==undefined){Options.Orientation=1}var _realWidth=0;var _realHeight=0;if(Options.Orientation!=1){Options.transX=parseInt(Options.width/2);Options.transY=parseInt(Options.height/2)}else{Options.transX=0;Options.transY=0}_realWidth=_realImage.width;_realHeight=_realImage.height;var XDimension=_exifInfo["PixelXDimension"];var YDimension=_exifInfo["PixelYDimension"];Options.XDimension=XDimension;Options.YDimension=YDimension;var tmpCanvas=document.createElement("canvas");tmpCanvas.width=Options.width;tmpCanvas.height=Options.height;var tmpContext=tmpCanvas.getContext("2d");tmpContext.clearRect(0,0,tmpCanvas.width,tmpCanvas.height);drawImageIOSFix(tmpContext,_realImage,0,0,_realWidth,_realHeight,0,0,_realWidth,_realHeight);var _canvas=document.createElement("canvas");var _context=_canvas.getContext("2d");switch(Options.Orientation){case 8:_realWidth=YDimension;_realHeight=XDimension;_canvas.width=_realWidth;_canvas.height=_realHeight;_context.translate(parseInt(_realWidth/2),parseInt(_realHeight/2));_context.rotate(-.5*Math.PI);_context.drawImage(tmpCanvas,0,0,tmpCanvas.width,tmpCanvas.height,0-Options.transX,0-Options.transY,tmpCanvas.width,tmpCanvas.height);break;case 3:_realWidth=XDimension;_realHeight=YDimension;_canvas.width=_realWidth;_canvas.height=_realHeight;_context.translate(parseInt(_realWidth/2),parseInt(_realHeight/2));_context.rotate(Math.PI);_context.drawImage(tmpCanvas,0,0,tmpCanvas.width,tmpCanvas.height,0-Options.transX,0-Options.transY,tmpCanvas.width,tmpCanvas.height);break;case 6:_realWidth=YDimension;_realHeight=XDimension;_canvas.width=_realWidth;_canvas.height=_realHeight;_context.translate(parseInt(_realWidth/2),parseInt(_realHeight/2));_context.rotate(.5*Math.PI);_context.drawImage(tmpCanvas,0,0,tmpCanvas.width,tmpCanvas.height,0-Options.transX,0-Options.transY,tmpCanvas.width,tmpCanvas.height);break;case 1:_canvas.width=_realWidth;_canvas.height=_realHeight;_context.drawImage(tmpCanvas,0,0,_realWidth,_realHeight,0-Options.transX,0-Options.transY,tmpCanvas.width,tmpCanvas.height);break}var _base64=_canvas.toDataURL();settings.onFix(_base64);return}};_app.init();var returnObject={getExif:function(){return _exifInfo}};return returnObject};