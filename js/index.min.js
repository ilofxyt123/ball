(function(a){"function"===typeof define&&define.amd?define(["exports"],function(b){window.Orienter=a(b)}):"undefined"!==typeof exports?a(exports):window.Orienter=a({})})(function(a){a=function(){this.initialize.apply(this,arguments)};a.prototype={lon:0,lat:0,direction:0,fix:0,os:"",initialize:function(a){a=a||{};this.onOrient=a.onOrient||function(){};this.onChange=a.onChange||function(){};this._orient=this._orient.bind(this);this._change=this._change.bind(this);this.lat=this.lon=0;this.direction=window.orientation||0;switch(this.direction){case 0:this.fix=0;break;case 90:this.fix=-270;break;case-90:this.fix=-90}navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)?this.os="ios":this.os=-1<navigator.userAgent.indexOf("Android")||navigator.userAgent.indexOf("Linux")?"android":""},init:function(){window.addEventListener("deviceorientation",this._orient,!1);window.addEventListener("orientationchange",this._change,!1)},destroy:function(){window.removeEventListener("deviceorientation",this._orient,!1);window.removeEventListener("orientationchange",this._change,!1)},_change:function(a){this.direction=window.orientation;this.onChange(this.direction)},changeDirectionTo:function(a){this.direction=a},_orient:function(a){switch(this.os){case"ios":switch(this.direction){case 0:this.lon=a.alpha+a.gamma;0<a.beta&&(this.lat=a.beta-90);break;case 90:this.lon=0>a.gamma?a.alpha-90:a.alpha-270;this.lat=0<a.gamma?90-a.gamma:-90-a.gamma;break;case-90:this.lon=0>a.gamma?a.alpha-90:a.alpha-270,this.lat=0>a.gamma?90+a.gamma:-90+a.gamma}break;case"android":switch(this.direction){case 0:this.lon=a.alpha+a.gamma+30;this.lat=90<a.gamma?90-a.beta:a.beta-90;break;case 90:this.lon=a.alpha-230;this.lat=0<a.gamma?270-a.gamma:-90-a.gamma;break;case-90:this.lon=a.alpha-180,this.lat=-90+a.gamma}}this.lon+=this.fix;this.lon%=360;0>this.lon&&(this.lon+=360);this.lon=Math.round(this.lon);this.lat=Math.round(this.lat);this.onOrient({a:Math.round(a.alpha),b:Math.round(a.beta),g:Math.round(a.gamma),lon:this.lon,lat:this.lat,dir:this.direction})}};return a});var onJQAnimationEndHandle=function(option){switch(option.type){case"fadeIn":this.removeClass("opacity "+option.ani);break;case"fadeOut":this.hide().removeClass(option.ani);break}if(option.callback){option.callback.call(this)}this.off("webkitAnimationEnd").css({animationDuration:""})};$.fn.extend({fi:function(option){var _this=this;var options={ani:"ani-fadeIn",duration:"500",callback:undefined,type:"fadeIn"};if(option){jQuery.extend(options,option)}this.on("webkitAnimationEnd",function(e){e.stopPropagation();onJQAnimationEndHandle.call(_this,options)}).css({animationDuration:options.duration+"ms"}).addClass("opacity "+options.ani).show();return this},fo:function(option){var _this=this;var options={ani:"ani-fadeOut",duration:"500",callback:undefined,type:"fadeOut"};if(option){jQuery.extend(options,option)}this.on("webkitAnimationEnd",function(e){e.stopPropagation();onJQAnimationEndHandle.call(_this,options)}).css({animationDuration:options.duration+"ms"}).addClass(options.ani);return this}});if(Object.assign===undefined){(function(){Object.assign=function(target){"use strict";if(target===undefined||target===null){throw new TypeError("Cannot convert undefined or null to object")}var output=Object(target);for(var index=1;index<arguments.length;index++){var source=arguments[index];if(source!==undefined&&source!==null){for(var nextKey in source){if(Object.prototype.hasOwnProperty.call(source,nextKey)){output[nextKey]=source[nextKey]}}}}return output}})()}var Utils=new function(){this.ImageLoader=function ImageLoader(){this.total=0;this.haveload=0;this.percent=0;this.complete=false;this.version=""};this.lazyLoad=function(){var a=$(".lazy");var len=a.length;var imgObj;var Load=function(){for(var i=0;i<len;i++){imgObj=a.eq(i);imgObj.attr("src",imgObj.attr("data-src"))}};Load()};this.browser=function(t){var u=navigator.userAgent;var u2=navigator.userAgent.toLowerCase();var p=navigator.platform;var browserInfo={trident:u.indexOf("Trident")>-1,presto:u.indexOf("Presto")>-1,webKit:u.indexOf("AppleWebKit")>-1,gecko:u.indexOf("Gecko")>-1&&u.indexOf("KHTML")==-1,mobile:!!u.match(/AppleWebKit.*Mobile.*/),ios:!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:u.indexOf("Android")>-1||u.indexOf("Linux")>-1,iPhone:u.indexOf("iPhone")>-1,iPad:u.indexOf("iPad")>-1,webApp:u.indexOf("Safari")==-1,iosv:u.substr(u.indexOf("iPhone OS")+9,3),weixin:u2.match(/MicroMessenger/i)=="micromessenger",taobao:u.indexOf("AliApp(TB")>-1,win:p.indexOf("Win")==0,mac:p.indexOf("Mac")==0,xll:p=="X11"||p.indexOf("Linux")==0,ipad:navigator.userAgent.match(/iPad/i)!=null?true:false};return browserInfo[t]};this.g=function(id){return document.getElementById(id)};this.limitNum=function(obj){var value=$(obj).val();var length=value.length;if(length>11){value=value.substring(0,11);$(obj).val(value)}}};Object.assign(Utils.ImageLoader.prototype,{load:function(urls,onEveryLoad,onComplete){var result={0:[]};this.total=urls.length;var _this=this;start();function onLoad(e){if(Object.prototype.hasOwnProperty.call(urls[_this.haveload],"group")){var group=urls[_this.haveload].group;if(result[group]instanceof Array==false){result[group]=[]}result[group].push(this)}else{result[0].push(this)}_this.haveload++;_this.percent=Math.floor(_this.haveload/_this.total*100);onEveryLoad(_this.percent);this.onload=null;if(_this.percent==100){_this.complete=true;onComplete(result);return}var img=new Image;img.onload=onLoad;img.src=urls[_this.haveload].url+_this.version;if(urls[_this.haveload].name){img["name"]=urls[_this.haveload].name}if(urls[_this.haveload].direction){img["direction"]=urls[_this.haveload].direction}}function start(){var img=new Image;img.onload=onLoad;img.src=urls[_this.haveload].url+_this.version;if(urls[_this.haveload].name){img["name"]=urls[_this.haveload].name}if(urls[_this.haveload].direction){img["dir"]=urls[_this.haveload].direction}}}});var Media=new function(){this.mutedEnd=false;this.WxMediaInit=function(){var _self=this;if(!Utils.browser("weixin")){this.mutedEnd=true;return}if(!Utils.browser("iPhone")){_self.mutedEnd=true;return}document.addEventListener("WeixinJSBridgeReady",function(){var $media=$(".iosPreload");$.each($media,function(index,value){_self.MutedPlay(value["id"]);if(index+1==$media.length){_self.mutedEnd=true}})},false)};this.MutedPlay=function(string){var str=string.split(",");var f=function(id){var media=Utils.g(id);media.volume=0;media.play();media.pause();media.volume=1;media.currentTime=0};if(!(str.length-1)){f(str[0]);return 0}str.forEach(function(value,index){f(value)})};this.playMedia=function(id){var _self=this;var clock=setInterval(function(){if(_self.mutedEnd){Utils.g(id).play();clearInterval(clock)}},20)}};Media.WxMediaInit();var options={el:"#iCreative",data:{server_data:{is_end:!!parseInt($("#is_end").val()),have_guanzhu:!!parseInt($("#have_guanzhu").val()),isVip:!!parseInt($("#is_vip").val()),goRegist:!!parseInt($("#goRegist").val()),haveFill:!!parseInt($("#haveFill").val()),prizeType:parseInt($("#prizeType").val()),province:[],city:[],address:[],name:"",tel:"",select_province:"",select_city:"",select_address:"",shop_id:0,myInfo:{province:"",city:"",shop:""}},ios:Utils.browser("ios"),ploading:{visible:false},pwebgl:{visible:false},p1:{visible:false},p2:{visible:false},pprize:{visible:false},pfill:{visible:false},paddress:{visible:false},pvideo:{visible:false},pend:{visible:false},pshare:{visible:false},pquery:{visible:false},pguanzhu:{visible:false},prule:{visible:false},palert:{visible:false,type:"",choice:{fill:"fill",normal:"normal",reg:"reg"},fontSize:"",content:"",title:"",txt:{fill:"你还未填写领奖信息，<br>赶快去填写吧",reg:"为了确保星球领奖者的真实性,<br>系统需要进行实名认证,<br>请填写个人真实信息领取奖品!"}},isResult:false,hpwarn:{visible:false},pwait:{visible:false}},methods:{p1BtnChoseSex:function(sex){webgl.sex=sex;this.p1.visible=false;this.pwebgl.visible=true;webgl.initBall()},top_btn_rule:function(){this.prule.visible=true;if(!main.scroll){main.scroll=new Scroll({container:".scroll-area",scrollObj:".scroller"})}},prule_btn_xx:function(){this.prule.visible=false},after_leave_rule:function(){main.scroll.set(0)},after_enter_rule:function(){main.scroll.update()},onPwebglEnter:function(){main.initLX({container:$(".P_webgl"),delay:3e3});main.initLX({container:$("#bg .bg2"),delay:1500});if(vm.key_index==3&&vm.server_data.prizeType==0&&!vm.server_data.is_end){$(".tip-all").show();$(".big-icon").show();$(".number").hide();$(".animation-box").fi()}},pwegbl_btn_chaxun:function(){this.pquery.visible=true},pwebgl_btn_getPrize:function(){if(!this.server_data.have_guanzhu){this.pguanzhu.visible=true;this.pwebgl.visible=false;main.stopRender();return}if(!this.server_data.isVip){var type=vm.palert.choice.reg;var content=vm.palert.txt[type];vm.openAlert(type,content);return}if(this.server_data.is_end){this.palert.type=this.palert.choice.normal;this.palert.content="本次活动已结束<br>期待EP雅莹更多活动<br>记得关注“EP雅莹官方微信”<br>敬请期待我们的下次活动";this.palert.visible=true;$(".animation-box").fo();return}var _vm=this;var callback=function(data){if(data.status){_vm.server_data.prizeType=data.lottery_result;_vm.pprize.visible=true;_vm.pwebgl.visible=false;setTimeout(function(){$(".animation-box").hide()},1e3);main.stopRender()}else{console.log("抽奖后台出问题了"+data)}};_getData.getPrize(callback)},pwebgl_btn_icon4:function(){var content="活动结束，该奖品已过期<br>下次请尽早哦！";this.openAlert("normal",content)},afterEnterPprize:function(){this.isResult=true;init_weixin_share()},afterLeavePprize:function(){this.isResult=false;init_weixin_share()},pprize_btn_paddress:function(){this.paddress.visible=true},pprize_btn_share:function(){this.pshare.visible=true},pprize_btn_pfill:function(){this.pfill.visible=true;this.pprize.visible=false},pprize_btn_close:function(){main.startRender();this.pprize.visible=false;this.pwebgl.visible=true},pquery_btn_paddress:function(){this.paddress.visible=true},pquery_btn_share:function(){this.pshare.visible=true},pquery_btn_xx:function(){this.pquery.visible=false},pfill_btn_submit:function(){var number=this.server_data.tel;var name=this.server_data.name;var patt=/^1(3|4|5|7|8)\d{9}$/;if(name==""){this.palert.type=this.palert.choice.normal;this.palert.content="请输入姓名";this.palert.visible=true;return}if(!patt.test(number)){this.palert.type=this.palert.choice.normal;this.palert.content="请输入正确的手机号";this.palert.visible=true;return}if(this.server_data.select_province==""){this.palert.type=this.palert.choice.normal;this.palert.content="请选择省份";this.palert.visible=true;return}if(this.server_data.select_city==""){this.palert.type=this.palert.choice.normal;this.palert.content="请选择城市";this.palert.visible=true;return}if(this.server_data.select_address==""){this.palert.type=this.palert.choice.normal;this.palert.content="请选择门店";this.palert.visible=true;return}var callback=function(result){if(result.status){location.href="index.php"}else{console.log(result)}};_uploadData.addInfo(callback)},onPfillProvinceChangeHandle:function(e){var _vm=this;_getData.getCity(function(data){_vm.server_data.city=data.data})},onPfillCityChangeHandle:function(e){var _vm=this;_getData.getShop(function(data){_vm.server_data.address=data.data})},onPfillAddressChangeHandle:function(e){this.server_data.shop_id=e.target.selectedOptions[0].getAttribute("shopid")},onPaddress_btn_xx:function(){this.paddress.visible=false},onPaddressProvinceChangeHandle:function(e){var _vm=this;_getData.getCity(function(data){_vm.server_data.city=data.data})},onPaddressCityChangeHandle:function(e){var _vm=this;_getData.getShop(function(data){_vm.server_data.address=data.data})},onPaddressAddressChangeHandle:function(e){},back:function(){var len=this.router.length;if(len>0){var page=this.router[len-1];this[page].visible=true;this.router.splice(len-1,1)}},palert_btn_gofill:function(){this.pfill.visible=true;this.closeAlert()},palert_btn_goregist:function(){var back_url="http://epshow.i-creative.cn/summer/index.php?is_reg=1";location.href="http://o2o.elegant-prosper.com/EPWXSiteNew/VIP/CreateVIP?sid=cfe404ea-fe5b-4a85-87f0-b2701929462c&redirect_uri="+encodeURIComponent(back_url)},onPshareEnter:function(){},openAlert:function(type,content,fontSize){var fontSize=fontSize?fontSize:"";this.palert.type=type;this.palert.content=content;this.palert.visible=true;this.palert.fontSize=fontSize},closeAlert:function(){this.palert.visible=false;this.palert.type="";this.palert.content="";this.palert.fontSize=""}},computed:{},delimiters:["$[","]"]};var vm=new Vue(options);vm.ploading.visible=true;var three=new function(){this.container;this.scene;this.camera;this.renderer;this.width;this.height;this.raycaster};three.init=function(){this.container=$("#WebGL");this.width=window.innerWidth;this.height=window.innerHeight;this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(45,this.width/this.height,.1,1e5);this.camera.position.set(0,25,0);this.ocamera=new THREE.OrthographicCamera(-this.width/2,this.width/2,this.height/2,-this.height/2,1,200);this.ocamera.position.y=50;this.ocamera.position.z=15;this.scene2=new THREE.Scene;this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true,precision:"highp"});this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.setSize(this.width,this.height);this.renderer.autoClear=false;this.container.append(this.renderer.domElement);this.raycaster=new THREE.Raycaster;this.ddsloader=new THREE.DDSLoader;THREE.Loader.Handlers.add(/\.dds$/i,this.ddsloader)};three.loadOBJ=function(config){config=config?config:{};config.modelName=config.modelName?config.modelName:function(){console.error("加载obj文件，modelName不能为空");return}();config.objFile=config.objFile?config.objFile:function(){console.error("加载obj文件，fileName不能为空");return}();config.material=config.material?config.material:undefined;config.needTouch=typeof config.needTouch=="boolean"?config.needTouch:true;config.callback=config.callback?config.callback:undefined;var objloader=new THREE.OBJLoader;if(config.material){objloader.setMaterials(config.material);console.log(config.material)}objloader.load(config.objFile,function(group){config.callback&&config.callback(group);group.name=config.modelName;group.position.x=webgl.OBJData[config.modelName].position.x;group.position.y=webgl.OBJData[config.modelName].position.y;group.position.z=webgl.OBJData[config.modelName].position.z;group.rotation.x=webgl.OBJData[config.modelName].rotation.x;group.rotation.y=webgl.OBJData[config.modelName].rotation.y;group.rotation.z=webgl.OBJData[config.modelName].rotation.z;group.scale.x=webgl.OBJData[config.modelName].scale.x;group.scale.y=webgl.OBJData[config.modelName].scale.y;group.scale.z=webgl.OBJData[config.modelName].scale.z;webgl.OBJData[config.modelName].obj=group;if(webgl.OBJData[config.modelName].needTouch){webgl.touchObjects.push(object)}main.loader.haveLoad++;var completePercent=Math.round(main.loader.haveLoad/main.loader.total*100);$(".num").html(100-completePercent);if(main.loader.haveLoad==main.loader.total){main.loadCallBack()}},function(progress){},function(error){console.log("加载obj出错")})};three.loadMTL=function(config){config=config?config:{};config.modelName=config.modelName?config.modelName:function(){console.error("加载mtl文件，modelName不能为空");return}();config.mtlFile=config.mtlFile?config.mtlFile:function(){console.error("加载mtl文件，文件名不能为空");return}();var mtlloader=new THREE.MTLLoader;if(config.baseUrl){mtlloader.setPath(config.baseUrl)}mtlloader.load(config.mtlFile,function(materials){materials.preload();if(config.objFile){three.loadOBJ({modelName:config.modelName,objFile:config.objFile,material:materials})}},function(res){},function(res){console.log("加载mtl出错")})};three.loadCollada=function(config){config=config?config:{};config.url=config.url;config.successCallback=typeof config.successCallback=="function"?config.successCallback:function(collada){console.log(collada)};config.progressCallback=config.progressCallback?config.progressCallback:function(progress){console.log(progress)};config.failCallback=config.failCallback?config.failCallback:function(fail){console.log(fail)};var loader=new THREE.ColladaLoader;loader.load(config.url,config.successCallback,config.progressCallback,config.failCallback)};three.loadTexture=function(config){config=config?config:{};config.url=config.url?config.url:"";config.name=config.name?config.name:"";config.wrapS=typeof config.wrapS=="boolean"?config.wrapS:false;config.wrapT=typeof config.wrapT=="boolean"?config.wrapT:false;config.SuccessCallback=typeof config.SuccessCallback=="function"?config.SuccessCallback:function(){};var textureLoader=new THREE.TextureLoader;textureLoader.setCrossOrigin("");var texture=textureLoader.load(config.url,function(texture){config.SuccessCallback(texture)},undefined,function(){});if(config.wrapS){texture.wrapS=THREE.RepeatWrapping}if(config.wrapT){texture.wrapT=THREE.RepeatWrapping}texture.name=config.name;return texture};three.loadAudio=function(config){var audioLoader=new THREE.AudioLoader};three.getSpotLight=function(config){config=config?config:{};config.color=config.color?config.color:16777215;config.intensity=config.intensity?config.intensity:1;config.distance=config.distance?config.distance:100;config.angle=config.angle?config.angle:Math.PI/3;config.exponent=config.exponent?config.exponent:10;var light=new THREE.SpotLight(config.color,config.intensity,config.distance,config.angle,config.exponent);light.position.x=100;light.position.y=100;light.position.z=0;return light};three.getPointLightHelper=function(spotLight){if(spotLight instanceof THREE.Light){return new THREE.SpotLightHelper(spotLight)}};three.getDirectionalLight=function(config){config=config?config:{};config.color=config.color?config.color:16777215;config.intensity=config.intensity?config.intensity:1;var light=new THREE.DirectionalLight(config.color,config.intensity);if(config.position){light.position.set(config.position.x,config.position.y,config.position.z)}return light};three.getAmbientLight=function(config){config=config?config:{};config.color=config.color?config.color:16777215;config.intensity=config.intensity?config.intensity:1;var light=new THREE.AmbientLight(config.color,config.intensity);return light};three.getSkyByCubeGeo=function(config){var path="assets/texture/";config=config?config:{};config.size=config.size?config.size:1024;config.format=config.format?config.format:".jpg";config.urls=config.urls?config.urls:[path+"right"+config.format,path+"left"+config.format,path+"up"+config.format,path+"down"+config.format,path+"front"+config.format,path+"back"+config.format];var materials=[];for(var i=0;i<config.urls.length;i++){materials.push(new THREE.MeshLambertMaterial({map:this.loadTexture({url:config.urls[i]}),side:THREE.BackSide}))}var mesh=new THREE.Mesh(new THREE.CubeGeometry(config.size,config.size,config.size),new THREE.MeshFaceMaterial(materials));return mesh};three.getSkyBySphere=function(config){config=config?config:{};config.R=config.R?config.R:50;config.Ws=config.Ws?config.Ws:8;config.Hs=config.Hs?config.Hs:6;config.phiStart=config.phiStart?config.phiStart:0;config.phiLength=config.phiLength?config.phiLength:2*Math.PI;config.thetaStart=config.thetaStart?config.thetaStart:0;config.thetaLength=config.thetaLength?config.thetaLength:Math.PI;config.texture=config.texture?config.texture:new THREE.Texture;var geometry=new THREE.SphereGeometry(config.R,config.Ws,config.Hs,config.phiStart,config.phiLength,config.thetaStart,config.thetaLength);var material=new THREE.MeshBasicMaterial({map:config.texture,side:THREE.DoubleSide});var mesh=new THREE.Mesh(geometry,material);return mesh};three.getCurveLineGeo=function(curve,segments,closed){var g=new THREE.Geometry;g.vertices=curve.getPoints(segments);console.log(curve.getPointAt(.5));return g};three.getCubeGeometry=function(config){config=config?config:{};config.sizeX=config.sizeX?config.sizeX:100;config.sizeY=config.sizeY?config.sizeY:100;config.sizeZ=config.sizeZ?config.sizeZ:100;config.Xs=config.Xs?config.Xs:1;config.Ys=config.Ys?config.Ys:1;config.Zs=config.Zs?config.Zs:1;var geometry=new THREE.CubeGeometry(config.sizeX,config.sizeY,config.sizeZ,config.Xs,config.Ys,config.Zs);return geometry};three.getPlaneGeo=function(config){config=config?config:{};config.width=config.width?config.width:50;config.height=config.height?config.height:50;config.Ws=config.Ws?config.Ws:1;config.Hs=config.Hs?config.Hs:1;var planeGeo=new THREE.PlaneGeometry(config.width,config.height,config.Ws,config.Hs);return planeGeo};three.getSphereGeometry=function(config){config=config?config:{};config.R=config.R?config.R:50;config.Ws=config.Ws?config.Ws:8;config.Hs=config.Hs?config.Hs:6;config.phiStart=config.phiStart?config.phiStart:0;config.phiLength=config.phiLength?config.phiLength:2*Math.PI;config.thetaStart=config.thetaStart?config.thetaStart:0;config.thetaLength=config.thetaLength?config.thetaLength:Math.PI;var geometry=new THREE.SphereGeometry(config.R,config.Ws,config.Hs,config.phiStart,config.phiLength,config.thetaStart,config.thetaLength);return geometry};three.getPointMaterial=function(config){config=config?config:{};config.size=config.size?config.size:4;config.map=config.map?config.map:undefined;config.blending=config.blending?config.blending:THREE.AdditiveBlending};three.getOrbitControls=function(config){config=config?config:{};return new THREE.OrbitControls(this.camera,this.renderer.domElement)};three.addPerspectiveCameraHelper=function(camera){camera=camera?camera:this.camera;var helper=new THREE.CameraHelper(camera);this.scene.add(helper);return helper};three.getFps=function(){var s=new Stats;return s};three.getObjectByName=function(config){config=config?config:{};config.name=config.name?config.name:function(){console.error("getObjectByName时缺少name")}();config.scene=config.scene?config.scene:this.scene;return config.scene.getObjectByName(config.name)};three.raycasterResult=function(config){config=config?config:{};config.coords=config.coords?config.coords:new THREE.Vector2;config.searchFrom=config.searchFrom?config.searchFrom:this.scene;config.recursive=config.recursive?config.recursive:false;config.needGroup=config.needGroup?config.needGroup:false;config.coords.x=config.coords.x/this.width*2-1;config.coords.y=2*-(config.coords.y/this.height)+1;this.raycaster.setFromCamera(config.coords,this.camera);var result;result=this.raycaster.intersectObjects(config.searchFrom,config.recursive);if(result.length>0){if(config.needGroup){if(result[0].object.parent&&result[0].object.parent instanceof THREE.Group){result=result[0].object.parent}}else{result=result[0]}}else{result=undefined}return result};three.getTime=function(){return(new Date).getTime()};three.getTouchCoords=function(event){return{x:event.offsetX,y:event.offsetY}};three.render=function(){this.renderer.clear();this.renderer.render(this.scene,this.camera);this.renderer.clearDepth();this.renderer.render(this.scene2,this.ocamera)};three.onresize=function(){this.width=window.innerWidth;this.height=window.innerHeight;this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix();this.ocamera.left=-this.width/2;this.ocamera.right=this.width/2;this.ocamera.top=this.height/2;this.ocamera.bottom=-this.height/2;this.ocamera.updateProjectionMatrix();this.renderer.setSize(this.width,this.height)};var curveTool=function(){var vector1=new THREE.Vector3;var vector2=new THREE.Vector3;var PI=Math.PI;var PI2=2*PI;var range=[0,PI2];return{getPointAt:function(t,quadrant,R,Clockwise,offset){offset=offset||new THREE.Vector3;range[0]=0+quadrant*(PI/2);range[1]=range[0]+PI/2;Clockwise=Clockwise||false;if(Clockwise){t=range[1]-t*PI/2}else{t=range[0]+t*PI/2}var x=R*Math.cos(t);var z=-R*Math.sin(t);vector1.set(x,0,z).add(offset);return vector1},getTangentAt:function(t,quadrant,R,Clockwise){var delta=1e-5;var tPre=Math.max(0,t-delta);var tNxt=Math.min(1,t+delta);Clockwise=Clockwise||false;vector2.copy(this.getPointAt(tNxt,quadrant,1,Clockwise)).sub(this.getPointAt(tPre,quadrant,1,Clockwise)).normalize();return vector2}}}();var webgl=new function(){this.debug=true;this.fps=undefined;this.orbit=undefined;this.gravity=undefined;this.loader={haveLoad:0,total:0,complete:false};this.assetsUrl="assets/";this.picUrl=this.assetsUrl+"images/";this.texturePath=this.assetsUrl+"images/";this.modelsUrl=this.assetsUrl+"models/";this.touchObjects=[];this.OBJData={scene:{name:"scene",baseUrl:this.assetsUrl,mtlFile:this.assetsUrl+"models/scene/scene.mtl",objFile:this.assetsUrl+"models/scene/scene.obj",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:.07,y:.07,z:.07},needTouch:false,liusu_center:undefined,liusu_up:undefined}};this.FBXData={bridge:{depth:80,name:"bridge",url:this.modelsUrl+"bridge.fbx",position:new THREE.Vector3,obj:undefined},curve:{name:"curve",url:this.modelsUrl+"curve.fbx",position:new THREE.Vector3,obj:{}}};this.TextureData={};const SQ3=Math.sqrt(3);const SQ2=Math.sqrt(2);this.skyBox=undefined;this.earthChangeTexture=[];this.textureIndex=0;this.ogroup=new THREE.Group;this.clock=new THREE.Clock;this.road=undefined;this.roadOptions={depth:1e3,segments:100,width:50};this.sex=0;this.ballOptions={ballRadius:4,speedX:0,speedZ:0,startSpeedZ:-1.5,maxZ:-.5,minZ:-1.5,maxX:1,minX:-1,ax:0,az:0,pause:false,startPosition:new THREE.Vector3(0,4,0),viewSpeedZ:0,texture:{},energy:1};this.state={init:"init",enter:"enter",wait:"wait",slowDown:"slowDown",startFrom0:"startFrom0",stage0:"stage0",stage1:"stage1",stage2:"stage2",stage3:"stage3",stage4:"stage4",stage5:"stage5",waitChose:"waitChose",runCurve:"runCurve",end:"end",bump:"bump"};this.mapData={stage0:{depth:400,segments:5,width:50,offset:new THREE.Vector3,start:new THREE.Vector3(0,0,0),end:new THREE.Vector3(0,0,-400),g_end:new THREE.Vector3(0,0,-400),distance:new THREE.Vector3(0,0,-200),g_distance:new THREE.Vector3(0,0,-200),dir:undefined,roadFBXGroup:undefined},stage1:{depth:800,segments:10,width:50,offset:new THREE.Vector3,start:new THREE.Vector3(0,0,0),end:new THREE.Vector3(0,0,-800),g_end:new THREE.Vector3,distance:new THREE.Vector3(0,0,-600),g_distance:new THREE.Vector3(0,0,0),dir:undefined,roadFBXGroup:undefined,left:{stone:{name:"",position:new THREE.Vector3(10,0,-300),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_grass:{name:"1",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(383,214,1),texture:undefined},left_build1:{name:"3",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(276,400,1),texture:undefined},left_build2:{name:"5",position:new THREE.Vector3(-50,10,-350),scale:new THREE.Vector3(240,425,1),texture:undefined},left_build3:{name:"7",position:new THREE.Vector3(-50,10,-450),scale:new THREE.Vector3(255,227,1),texture:undefined},left_build4:{name:"8",position:new THREE.Vector3(-50,10,-550),scale:new THREE.Vector3(137,421,1),texture:undefined},right_grass:{name:"2",position:new THREE.Vector3(50,10,-100),scale:new THREE.Vector3(440,260,1),texture:undefined},right_build1:{name:"6",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(205,423,1),texture:undefined},right_build2:{name:"4",position:new THREE.Vector3(100,10,-300),scale:new THREE.Vector3(391,322,1),texture:undefined}},right:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_grass:{name:"9",position:new THREE.Vector3(0,-10,-100),scale:new THREE.Vector3(1136,220,1),texture:undefined},left_build1:{name:"1",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(411,287,1),texture:undefined},left_build2:{name:"3",position:new THREE.Vector3(-75,10,-350),scale:new THREE.Vector3(449,325,1),texture:undefined},left_cow:{name:"5",position:new THREE.Vector3(-50,10,-320),scale:new THREE.Vector3(182,152,1),texture:undefined},left_tree1:{name:"2",position:new THREE.Vector3(-50,10,-380),scale:new THREE.Vector3(298,353,1),texture:undefined},left_build3:{name:"4",position:new THREE.Vector3(-50,10,-450),scale:new THREE.Vector3(449,325,1),texture:undefined},right_build1:{name:"6",position:new THREE.Vector3(75,10,-300),scale:new THREE.Vector3(505,417,1),texture:undefined},right_build2:{name:"8",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(338,256,1),texture:undefined},right_tree1:{name:"7",position:new THREE.Vector3(100,10,-200),scale:new THREE.Vector3(567,474,1),texture:undefined}}},stage2:{depth:800,segments:10,width:50,offset:new THREE.Vector3,start:new THREE.Vector3(0,0,0),end:new THREE.Vector3(0,0,-800),g_end:new THREE.Vector3,distance:new THREE.Vector3(0,0,-600),g_distance:new THREE.Vector3(0,0,0),dir:undefined,roadFBXGroup:undefined,left:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_grass:{name:"1",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(381,291,1),texture:undefined},left_people:{name:"3",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(118,242,1),texture:undefined},left_build1:{name:"4",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(486,453,1),texture:undefined},left_build2:{name:"5",position:new THREE.Vector3(-50,10,-350),scale:new THREE.Vector3(213,284,1),texture:undefined},right_grass:{name:"2",position:new THREE.Vector3(50,10,-100),scale:new THREE.Vector3(239,232,1),texture:undefined},right_build1:{name:"6",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(389,514,1),texture:undefined},right_build2:{name:"7",position:new THREE.Vector3(100,10,-300),scale:new THREE.Vector3(556,454,1),texture:undefined},right_build3:{name:"8",position:new THREE.Vector3(100,10,-300),scale:new THREE.Vector3(441,325,1),texture:undefined}},right:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_grass:{name:"1",position:new THREE.Vector3(0,-10,-100),scale:new THREE.Vector3(1136,176,1),texture:undefined},left_build1:{name:"2",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(603,654,1),texture:undefined},left_horse:{name:"5",position:new THREE.Vector3(-50,10,-320),scale:new THREE.Vector3(742,331,1),texture:undefined},right_build1:{name:"3",position:new THREE.Vector3(75,10,-300),scale:new THREE.Vector3(684,752,1),texture:undefined},right_build2:{name:"6",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(727,304,1),texture:undefined},right_couple:{name:"4",position:new THREE.Vector3(100,10,-200),scale:new THREE.Vector3(293,335,1),texture:undefined}}},stage3:{depth:800,segments:10,width:50,offset:new THREE.Vector3,start:new THREE.Vector3,end:new THREE.Vector3(0,0,-800),g_end:new THREE.Vector3,distance:new THREE.Vector3(0,0,-800),g_distance:new THREE.Vector3(0,0,0),dir:undefined,roadFBXGroup:undefined,left:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_grass:{name:"1",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(395,248,1),texture:undefined},left_couple:{name:"4",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(523,344,1),texture:undefined},left_build1:{name:"2",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(522,572,1),texture:undefined},right_build1:{name:"3",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(682,748,1),texture:undefined},right_horse:{name:"5",position:new THREE.Vector3(100,10,-300),scale:new THREE.Vector3(656,330,1),texture:undefined}},right:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10},left_people:{name:"1",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(362,297,1),texture:undefined},left_build1:{name:"4",position:new THREE.Vector3(-60,10,-100),scale:new THREE.Vector3(469,371,1),texture:undefined},left_build2:{name:"5",position:new THREE.Vector3(-50,10,-250),scale:new THREE.Vector3(535,403,1),texture:undefined},right_build1:{name:"2",position:new THREE.Vector3(50,10,-300),
scale:new THREE.Vector3(724,508,1),texture:undefined},right_build2:{name:"3",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(592,175,1),texture:undefined},right_build3:{name:"6",position:new THREE.Vector3(50,10,-300),scale:new THREE.Vector3(568,227,1),texture:undefined}}},stage4:{depth:800,segments:10,width:50,offset:new THREE.Vector3,start:new THREE.Vector3,end:new THREE.Vector3(0,0,-800),g_end:new THREE.Vector3,distance:new THREE.Vector3(0,0,-800),g_distance:new THREE.Vector3(0,0,0),dir:undefined,roadFBXGroup:undefined,left:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10}},right:{stone:{name:"",position:new THREE.Vector3(10,0,-450),g_position:new THREE.Vector3,scale:new THREE.Vector3(268,207,1),width:20,halfWidth:10}}},preStage:undefined,stage:"stage0",nextStage:"stage1",left:0,right:1,cross:2,curveR:240,stoneTexture:undefined};this.curvesData={left:undefined,right:undefined};this.curveType="";this.runData=undefined;this.cameraT=0;this.gameState=this.state["init"];this.ballMesh=undefined;this.curveLine1=undefined;this.curveLine2=undefined;this.straightLine=undefined;this.gravity={alpha:0,beta:0,gamma:0,lastGamma:0,deltaGamma:0,lastBeta:0,deltaBeta:0,allow:false,instance:undefined,orient:0,lon:0,lastLon:0,deltaLon:0}};webgl.init=function(){this.loader.total=Object.keys(this.OBJData).length;var _this=this;var t=(new THREE.TextureLoader).load(main.modelUrl+"bridge.jpg");t.needsUpdate=true;var material=new THREE.MeshLambertMaterial({map:t,wireframe:true});for(var prop in this.FBXData){loadFBX(_this.FBXData[prop])}function loadFBX(option){var fbxLoader=new THREE.FBXLoader;fbxLoader.load(option.url,function(group){switch(option.name){case"bridge":group.scale.set(13,13,13);group.position.set(-1.5,-3,-52);option.obj=group;group.traverse(function(object){if(object instanceof THREE.Mesh){object.material=material}});break;case"curve":group.traverse(function(object){if(object instanceof THREE.Mesh){object.material=material}});group.scale.multiplyScalar(12);group.position.set(120,-2,-130);option.obj[_this.mapData.left]=group.clone().rotateZ(Math.PI);option.obj[_this.mapData.right]=group.clone();break}},function(e){},function(e){})}};webgl.load=function(){for(var prop in this.OBJData){var config=this.OBJData[prop];three.loadOBJ({modelName:config.name,objFile:config.objFile,callback:function(group){webgl.stone1=group.children[0];webgl.stone2=group.children[1];webgl.liusu_up=group.children[2];webgl.liusu_center=group.children[3];webgl.planet=group.children[4]}})}};webgl.loadCallback=function(){var _this=this;var stage=this.mapData.stage;var stageOption=this.mapData[stage];initAmbientLight();_this.createNextRoadWithFBX();initBuild();initGravity.call(this);function initAmbientLight(){var ambientLight=three.getAmbientLight({color:0,intensity:1});three.scene.add(ambientLight)}function initBuild(){}function initGravity(){var scope=this;var gravity=this.gravity;gravity.instance=new Orienter;gravity.instance.onOrient=function(data){if(gravity.allow){switch(gravity.orient){case 0:gravity.lon=data.g;break;default:gravity.lon=data.b*gravity.orient;break}gravity.deltaLon=gravity.lon-gravity.lastLon;if(gravity.deltaLon<5){var speedX=gravity.lon/45*2*scope.ballOptions.maxX;if(speedX>scope.ballOptions.minX){if(speedX<scope.ballOptions.maxX){scope.ballOptions.speedX=speedX}else{scope.ballOptions.speedX=scope.ballOptions.maxX}}else{scope.ballOptions.speedX=scope.ballOptions.minX}}webgl.calCollision();gravity.lastLon=gravity.lon}};gravity.instance.init()}if(this.debug){initGui.call(this);initAxisHelper();initFps.call(this);CurveTest.call(this);createPlaneFloor(stageOption)}function initOrbit(){this.orbit=new THREE.OrbitControls(three.camera,$("#gl-touch")[0])}function initGui(){var _this=this;var ballOptions=function(){this.name="球";this.速度Z=_this.ballOptions.minZ;this.速度X=0;this.提升性能=false;this.暂停=false;this.回到起点=function(){webgl.reset()};this.出发=function(){webgl.start()};this.左拐=function(){_this.curveType="left";_this.updateCurvesData(49,_this.mapData.curveR);_this.updateNextMapInfo();_this.createNextRoadWithFBX();_this.gravity.allow=false;_this.gameState=_this.state["runCurve"];_this.runCurve(function(){console.log("弯道结束");three.camera.rotation.y=0;three.camera.rotation.x=0;var stage=_this.mapData.stage;_this.gameState=_this.state[stage];var obj=_this.ballOptions;TweenMax.to(obj,1,{speedZ:obj.startSpeedZ,onComplete:function(){_this.gravity.allow=true}})})};this.右拐=function(){_this.curveType="right";_this.updateCurvesData(49,_this.mapData.curveR);_this.updateNextMapInfo();_this.createNextRoadWithFBX();_this.gravity.allow=false;_this.gameState=_this.state["runCurve"];webgl.runCurve(function(){console.log("弯道结束");three.camera.rotation.y=0;three.camera.rotation.x=0;var stage=_this.mapData.stage;_this.gameState=_this.state[stage];var obj=_this.ballOptions;TweenMax.to(obj,1,{speedZ:obj.startSpeedZ,onComplete:function(){_this.gravity.allow=true}})})}};var roadOptions=function(){this.name="路";this.看场景1=function(){_this.orbit.target=(new THREE.Vector3).copy(_this.mapData.stage1.offset)};this.看场景2=function(){_this.orbit.target=(new THREE.Vector3).copy(_this.mapData.stage2.offset)};this.看场景3=function(){_this.orbit.target=(new THREE.Vector3).copy(_this.mapData.stage3.offset)};this.看场景4=function(){_this.orbit.target=(new THREE.Vector3).copy(_this.mapData.stage4.offset)};this.看球=function(){_this.orbit.target=(new THREE.Vector3).copy(_this.ballMesh.position)}};var gui=new dat.GUI;var ballOp=new ballOptions;var roadOp=new roadOptions;var folderBall=gui.addFolder(ballOp.name);folderBall.add(ballOp,"速度Z",this.ballOptions.minZ*10,0).onChange(function(value){webgl.ballOptions.speedZ=value/10});folderBall.add(ballOp,"速度X",this.ballOptions.minX*20,this.ballOptions.maxX*20).onChange(function(value){webgl.ballOptions.speedX=value/20});folderBall.add(ballOp,"暂停").onChange(function(value){webgl.ballOptions.pause=value});folderBall.add(ballOp,"提升性能").onChange(function(value){if(value){three.renderer.setPixelRatio(1)}else{three.renderer.setPixelRatio(window.devicePixelRatio)}});folderBall.add(ballOp,"回到起点").onChange(function(e){console.log("回到起点")});folderBall.add(ballOp,"出发").onChange(function(e){console.log("出发")});folderBall.add(ballOp,"左拐").onChange(function(e){console.log("左拐")});folderBall.add(ballOp,"右拐").onChange(function(e){console.log("右拐")});var folderRoad=gui.addFolder(roadOp.name);folderRoad.add(roadOp,"看场景1").onChange(function(e){console.log("看场景1")});folderRoad.add(roadOp,"看场景2").onChange(function(e){console.log("看场景2")});folderRoad.add(roadOp,"看场景3").onChange(function(e){console.log("看场景3")});folderRoad.add(roadOp,"看场景4").onChange(function(e){console.log("看场景4")});folderRoad.add(roadOp,"看球").onChange(function(e){console.log("看球")});$("#gui").append(gui.domElement)}function initAxisHelper(){var helper=new THREE.AxisHelper(1e3);three.scene.add(helper)}function initFps(){this.fps=three.getFps();document.getElementById("FPS").appendChild(this.fps.domElement)}function CurveTest(){var curve=new THREE.CatmullRomCurve3([new THREE.Vector3(0,0,0),new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,0,-2)]);var geo=three.getCurveLineGeo(curve,50,true);var material=new THREE.LineBasicMaterial({color:16711680});var line=new THREE.Line(geo,material);line.position.set(0,5,0);three.scene.add(line);this.curveLine1=line;var start=new THREE.Vector3(0,0,0);var end=new THREE.Vector3(0,0,-200);var path=new THREE.CatmullRomCurve3([start,end]);var geo=three.getCurveLineGeo(path,50,true);var material=new THREE.LineBasicMaterial({color:16711680});var line=new THREE.Line(geo,material);line.position.set(0,5,0);three.scene.add(line);this.straightLine=line;var divisions=49;var offset=new THREE.Vector3;var points=[];points=this.getPointsFromCurve(points,divisions,offset);geo=new THREE.Geometry;geo.vertices=points;var material=new THREE.LineBasicMaterial({color:255});var line=new THREE.Line(geo,material);line.position.set(0,0,0).add(offset);three.scene.add(line);this.line=line}function createPlaneFloor(option){var t=new THREE.Texture(main.ImageResult["floor"][0]);t.needsUpdate=true;var material=new THREE.MeshLambertMaterial({map:t,side:THREE.DoubleSide});var roadGroup=createRoadGeo(option.depth,option.segments,option.width,material);_this.road=roadGroup;three.scene.add(roadGroup);function createRoadGeo(depth,depthSegments,width,material){var segment_depth=depth/depthSegments;var road=new THREE.Group;var g,mesh;for(var i=0;i<depthSegments;i++){g=three.getPlaneGeo({width:width,height:segment_depth});mesh=new THREE.Mesh(g,material);mesh.rotation.set(-Math.PI/2,0,0);mesh.position.set(0,0,-i*segment_depth);road.add(mesh)}road.position.add(webgl.mapData[webgl.mapData.stage].offset);return road}}};webgl.createStage=function(){var stage=this.mapData.stage;this.mapData.nextStage=this.mapData.stage+1;this.mapData.preStage=this.mapData.stage-1};webgl.reset=function(){this.ballMesh.position.set(0,this.ballOptions.ballRadius,0);this.ballOptions.speedX=0;this.ballOptions.speedZ=0;this.setCameraFollowBall();this.gameState=this.state.wait};webgl.start=function(){this.gameState=this.state.startFrom0;var _this=this;var obj=this.ballOptions;_this.gravity.allow=true;TweenMax.to(obj,1,{speedZ:obj.startSpeedZ,onComplete:function(){_this.gameState=_this.state.stage0}})};webgl.slowDown=function(callback){var _this=this;var obj=this.ballOptions;if(callback==undefined){callback=function(){console.log("减速停下")}}TweenMax.to(obj,1,{speedZ:0,speedX:0,onComplete:function(){_this.gameState=_this.state.waitChose},onComplete:callback})};webgl.initBall=function(){var option=this.ballOptions;var g=three.getSphereGeometry({R:option.ballRadius,Ws:32,Hs:16});var t=option.texture[this.sex];var m=new THREE.MeshPhongMaterial({map:t,transparent:true});var mesh=new THREE.Mesh(g,m);mesh.position.set(option.startPosition.x,option.startPosition.y,option.startPosition.z);three.scene.add(mesh);this.ballMesh=mesh;var _this=this;var destination=(new THREE.Vector3).addVectors(_this.ballOptions.startPosition,new THREE.Vector3(0,0,-70));_this.gameState=_this.state.enter;setTimeout(function(){_this.ballScrollTo(destination,2,function(){_this.gameState=_this.state.wait})},1e3)};webgl.getPointsFromCurve=function(points,divisions,offset){for(var i=0;i<divisions;i++){var point=(new THREE.Vector3).copy(curveTool.getPointAt(i/divisions,1,100,true));point.add(offset);points.push(point)}return points};webgl.getRoadData=function(start){};webgl.createNextRoadWithFBX=function(){var _this=this;var stage=this.mapData.stage,order=stage.slice(-1);var stageOption=this.mapData[stage];if(order!=0){_this.runData=_this.curvesData[_this.curveType];if(this.debug){geo=new THREE.Geometry;geo.vertices=this.runData.points;var material=new THREE.LineBasicMaterial({color:255});var line=new THREE.Line(geo,material);line.position.set(0,0,0).add(this.mapData[this.mapData.preStage].g_end);three.scene.add(line);this.line=line}}if(stageOption.dir==undefined){}var number=stageOption.depth/_this.FBXData["bridge"].depth;var group=new THREE.Group;for(var i=0;i<number;i++){var model=_this.FBXData["bridge"].obj.clone();model.position.add(new THREE.Vector3(0,0,-i*_this.FBXData["bridge"].depth));group.add(model)}var left_fbx=_this.FBXData["curve"].obj[0].clone();var offset_inner=(new THREE.Vector3).copy(stageOption.end);offset_inner.add(new THREE.Vector3(-240,0,0));left_fbx.position.add(offset_inner);group.add(left_fbx);var right_fbx=_this.FBXData["curve"].obj[1].clone();offset_inner.add(new THREE.Vector3(240,0,0));right_fbx.position.add(offset_inner);group.add(right_fbx);group.position.add(stageOption.offset);if(order!=0){var direction=_this.curveType;var data=stageOption[direction];if(direction=="left"){right_fbx=_this.FBXData["curve"].obj[1].clone();right_fbx.rotateX(-Math.PI);right_fbx.position.add(new THREE.Vector3(0,0,240));group.add(right_fbx)}else if(direction=="right"){right_fbx=_this.FBXData["curve"].obj[1].clone();right_fbx.rotateZ(Math.PI);right_fbx.rotateX(Math.PI);right_fbx.position.add(new THREE.Vector3(-240,0,240));group.add(right_fbx)}for(var name in data){var t;var scale,position;if(name=="stone"){t=_this.mapData.stoneTexture}else{t=data[name].texture}if(name=="stone"){scale=(new THREE.Vector3).copy(data[name].scale).multiplyScalar(.1)}else{scale=(new THREE.Vector3).copy(data[name].scale).multiplyScalar(.15)}var g=three.getPlaneGeo({width:scale.x,height:scale.y});var m=new THREE.MeshBasicMaterial({map:t,transparent:true,side:THREE.DoubleSide,depthWrite:false});var mesh=new THREE.Mesh(g,m);mesh.position.copy(data[name].position);group.add(mesh)}}stageOption.roadFBXGroup=group;three.scene.add(group);function updateCurvesData(divisions,R){var left_points=[];var right_points=[];var t,quadrant=0,Clockwise;var offset=new THREE.Vector3;var offset1=(new THREE.Vector3).copy(stageOption.end);for(var qn=4;quadrant<qn;quadrant++){switch(quadrant){case 0:offset.set(-R,0,0);Clockwise=false;break;case 1:offset.set(R,0,0);Clockwise=true;break;case 2:offset.set(-R,0,-2*R);Clockwise=true;break;case 3:offset.set(R,0,-2*R);Clockwise=false;break}offset.add(offset1);for(var i=0;i<=divisions;i++){t=i/divisions;var point=(new THREE.Vector3).copy(curveTool.getPointAt(t,quadrant,R,Clockwise,offset));if(quadrant==0||quadrant==2){left_points.push(point)}if(quadrant==1||quadrant==3){right_points.push(point)}}}_this.curvesData.left=new THREE.CatmullRomCurve3(left_points);_this.curvesData.right=new THREE.CatmullRomCurve3(right_points)}};webgl.updateCurvesData=function(divisions,R){var _this=this;var stage=this.mapData.stage,order=stage.slice(-1);var stageOption=this.mapData[stage];var left_points=[];var right_points=[];var t,quadrant=0,Clockwise;var offset=new THREE.Vector3;var offset1=(new THREE.Vector3).copy(stageOption.g_end);for(var qn=4;quadrant<qn;quadrant++){switch(quadrant){case 0:offset.set(-R,0,0);Clockwise=false;break;case 1:offset.set(R,0,0);Clockwise=true;break;case 2:offset.set(-R,0,-2*R);Clockwise=true;break;case 3:offset.set(R,0,-2*R);Clockwise=false;break}offset.add(offset1);for(var i=0;i<=divisions;i++){t=i/divisions;var point=(new THREE.Vector3).copy(curveTool.getPointAt(t,quadrant,R,Clockwise,offset));if(quadrant==0||quadrant==2){left_points.push(point)}if(quadrant==1||quadrant==3){right_points.push(point)}}}_this.curvesData.left=new THREE.CatmullRomCurve3(left_points);_this.curvesData.right=new THREE.CatmullRomCurve3(right_points)};webgl.updateNextMapInfo=function(){var nowStage=this.mapData.stage;var nowN=parseInt(nowStage.slice(-1));var nextN=nowN+1;nextStage="stage"+nextN;this.mapData.preStage=nowStage;this.mapData.stage=nextStage;var type=this.curveType;var offsetR;if(type=="left"){offsetR=new THREE.Vector3(-2*this.mapData.curveR,0,-2*this.mapData.curveR)}else if(type=="right"){offsetR=new THREE.Vector3(2*this.mapData.curveR,0,-2*this.mapData.curveR)}this.mapData[nextStage].offset.addVectors(this.mapData[nowStage].g_end,offsetR);var global_offset=this.mapData[nextStage].offset;this.mapData[nextStage].g_distance.addVectors(this.mapData[nextStage].distance,global_offset);this.mapData[nextStage].g_end.addVectors(this.mapData[nextStage].end,global_offset);this.mapData[nextStage][type].stone.g_position.addVectors(global_offset,this.mapData[nextStage][type].stone.position)};webgl.ballScrollTo=function(destination,duration,callback){var v=new THREE.Vector3(0,0,0);var position=this.ballMesh.position;var prePos=new THREE.Vector3(0,0,0).copy(position);TweenMax.to(position,duration,{x:destination.x,z:destination.z,onUpdate:function(v3){v.subVectors(position,prePos);webgl.ballOptions.speedX=v.x;webgl.ballOptions.speedZ=v.z;prePos.copy(position)},onUpdateParams:[position],onComplete:callback})};webgl.addEarth=function(){var group=new THREE.Group;group.scale.set(0,0,0);group.position.set(0,50,-200);group.rotation.y=2*Math.PI;var material=new THREE.MeshPhongMaterial({map:three.loadTexture({url:this.assetsUrl+"models/scene/planet.png"}),normalMap:three.loadTexture({url:this.assetsUrl+"models/scene/normal_planet.png"}),shininess:20,emissive:1118481,emissiveIntensity:0});this.planet.material=material;group.add(this.planet);var material3=new THREE.MeshLambertMaterial({color:"white",map:three.loadTexture({url:this.assetsUrl+"models/scene/ls/1.png"}),side:THREE.DoubleSide,depthWrite:false,transparent:true,opacity:.8});this.liusu_up.material=material3;this.liusu_up.scale.set(1.01,1.01,1.01);this.liusu_up.rotation.set(2,2,2);group.add(this.liusu_up);var material4=new THREE.MeshLambertMaterial({color:"white",map:three.loadTexture({url:this.assetsUrl+"models/scene/ls/1.png"}),side:THREE.DoubleSide,depthWrite:false,transparent:true,opacity:.8});this.liusu_center.material=material4;this.liusu_center.scale.set(1.01,1.01,1.01);this.liusu_center.rotation.set(1.01,1.01,1.01);group.add(this.liusu_center);this.earthGroup=group;three.scene.add(group);for(point in this.PointData){var points=this.PointData;var point=points[point];point.texture=three.loadTexture({url:point.texture});var RedPoint2=new THREE.Sprite(new THREE.SpriteMaterial({map:point.texture,depthWrite:false}));RedPoint2.position.set(point.position.x,point.position.y,point.position.z);RedPoint2.scale.set(point.width*1.3,point.width*1.3,1);group.add(RedPoint2);RedPoint2.name=point.name;point.obj=RedPoint2}};webgl.addStars=function(){var texture=three.loadTexture({url:this.picUrl+"star2.png"});var mat=new THREE.SpriteMaterial({map:texture,transparent:true,depthWrite:false});this.stars=new THREE.Group;for(var i=0;i<200;i++){var axis=parseInt(Math.random()*3);switch(axis){case 0:var x=THREE.Math.randFloat(800,1e3);var y=THREE.Math.randFloat(0,1e3);var z=THREE.Math.randFloat(0,1e3);break;case 1:var x=THREE.Math.randFloat(0,1e3);var y=THREE.Math.randFloat(800,1e3);var z=THREE.Math.randFloat(0,1e3);break;case 2:var x=THREE.Math.randFloat(0,1e3);var y=THREE.Math.randFloat(0,1e3);var z=THREE.Math.randFloat(800,1e3);break}var flag=Math.random()-.5>0?1:-1;x*=flag;flag=Math.random()-.5>0?1:-1;y*=flag;flag=Math.random()-.5>0?1:-1;z*=flag;var sprite=new THREE.Sprite(mat);var rand=THREE.Math.randFloat(30,50);sprite.scale.set(rand,rand,1);sprite.position.set(x,y,z);this.stars.add(sprite)}three.scene.add(this.stars)};webgl.addSky=function(){var skyMesh=three.getSkyByCubeGeo({size:2048});this.sky=skyMesh;three.scene.add(skyMesh)};webgl.StraightRoad=function(path,divisions){THREE.bufferGeometry.call(this);var _this=this;var point=new THREE.Vector3;var steps=[new THREE.Vector3(-6,3,0),new THREE.Vector3(-5,2,0),new THREE.Vector3(5,2,0),new THREE.Vector3(6,3,0)];var vertexCount=divisions*steps.length;var positions=new THREE.BufferAttribute(new Float32Array(vertexCount*3),3);var normals=new THREE.BufferAttribute(new Float32Array(vertexCount*3),3);var uvs=new THREE.BufferAttribute(new Float32Array(vertexCount*2),2);function createShape(shape,offset){for(var j=0,jl=shape.length;j<jl;j++){}}for(var i=0,il=divisions;i<il;i++){point=path.getPointAt(i/il);createShape(steps,0)}this.addAttribute("position",positions);this.addAttribute("normals",normals);this.addAttribute("uvs",uvs)};webgl.StraightRoad.prototype=Object.create(THREE.BufferGeometry.prototype);webgl.CurveRoad=function(curve,divisions){THREE.BufferGeometry.call(this);var vertices=[];var normals=[];var colors=[];var up=new THREE.Vector3(0,1,0);var forward=new THREE.Vector3(0,0,-1);var right=new THREE.Vector3(1,0,0);var quaternion=new THREE.Quaternion;var prevQuaternion=new THREE.Quaternion;var PI2=Math.PI*2;for(var i=0,il=divisions;i<il;i++){}this.addAttribute("position",new THREE.BufferAttribute(new Float32Array(vertices),3));this.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(normals),3));this.addAttribute("color",new THREE.BufferAttribute(new Float32Array(colors),3))};webgl.updateStar=function(){var number=this.stars.children.length;for(var i=0;i<number;i++){var rand=parseInt(10*Math.random());TweenMax.fromTo(this.stars.children[i].material,1,{opacity:1},{opacity:0,repeat:-1,yoyo:true})}};webgl.updateTexture=function(){this.liusu_center.material.map=this.earthChangeTexture[this.textureIndex];this.liusu_up.material.map=this.earthChangeTexture[this.textureIndex];this.liusu_center.material.needsUpdate=true;this.liusu_up.material.needsUpdate=true;this.liusu_center.rotation.x+=.001;this.liusu_center.rotation.y+=.001;this.liusu_center.rotation.z+=.001;this.liusu_up.rotation.x+=.001;this.liusu_up.rotation.y+=.001;this.liusu_up.rotation.z+=.001;if(this.textureIndex<this.earthChangeTexture.length-1){this.textureIndex++}else{this.textureIndex=0}};webgl.ballRender=function(){var speedX=this.ballOptions.speedX;var speedZ=this.ballOptions.speedZ;this.ballMesh.position.z+=speedZ;this.ballMesh.position.x+=speedX;var tempMat=new THREE.Matrix4;tempMat.makeRotationAxis(new THREE.Vector3(0,0,1),-speedX/this.ballOptions.ballRadius);tempMat.multiply(this.ballMesh.matrix);this.ballMesh.matrix=tempMat;tempMat=new THREE.Matrix4;tempMat.makeRotationAxis(new THREE.Vector3(1,0,0),speedZ/this.ballOptions.ballRadius);tempMat.multiply(this.ballMesh.matrix);this.ballMesh.matrix=tempMat;this.ballMesh.rotation.setFromRotationMatrix(this.ballMesh.matrix)};webgl.getViewSpeed=function(){var range=100;this.ballOptions.viewSpeedZ=Math.abs(this.ballOptions.speedZ)/(this.ballOptions.maxZ-this.ballOptions.minZ)*range};webgl.calCollision=function(){var scope=this;var left_distance=calEdge(this.ballMesh.position.x);var range=[this.ballOptions.minZ,this.ballOptions.maxZ];if(left_distance<5){this.ballOptions.speedZ=left_distance/5*(range[0]-range[1])+this.ballOptions.maxZ;if(calEdge(this.ballMesh.position.x+this.ballOptions.speedX)<0){this.ballOptions.speedX=0}}else{this.ballOptions.speedZ=(range[0]-range[1])*this.ballOptions.energy+this.ballOptions.maxZ}function calEdge(x){var distance;var roadWidth=scope.roadOptions.width;distance=roadWidth/2-Math.abs(x-scope.mapData[scope.mapData.stage].offset.x);distance-=scope.ballOptions.ballRadius;return distance}};webgl.testStone=function(){var stage=this.mapData.stage;var direction=this.curveType;var stoneOption=this.mapData[stage][direction].stone;var stonePos=stoneOption.position;var testX=false;var testZ=false;if(this.ballMesh.position.z>stoneOption.g_position.z&&this.ballMesh.position.z+this.ballOptions.speedZ<stoneOption.g_position.z){testZ=true}if(Math.abs(this.ballMesh.position.x-stoneOption.g_position.x)<stoneOption.halfWidth){testX=true}if(testZ&&testX){this.gameState=this.state.bump;this.ballOptions.energy=0;TweenMax.fromTo(this.ballMesh.material,.5,{opacity:0},{opacity:1,yoyo:true,repeat:6});TweenMax.to(this.ballOptions,1,{energy:1,onComplete:function(){webgl.gameState=webgl.state[webgl.mapData.stage]}})}};webgl.setCameraFollowBall=function(){three.camera.position.x=this.ballMesh.position.x;three.camera.position.z=this.ballMesh.position.z+70};webgl.setCameraPositionOnCurve=function(t){var position=this.runData.getPoint(t);three.camera.position.x=position.x;three.camera.position.z=position.z;var v=(new THREE.Vector3).subVectors(this.ballMesh.position,three.camera.position)};webgl.runCurve=function(callback){var _this=this;var obj={t:0};if(callback==undefined){callback=function(){}}var v=new THREE.Vector3;var prePos=(new THREE.Vector3).copy(this.ballMesh.position);var position=(new THREE.Vector3).copy(prePos);var T=TweenMax.to(obj,4,{t:1,onUpdate:function(obj){if(obj.t>.1){_this.cameraT=obj.t-.1}else{_this.cameraT=0}position.copy(_this.runData.getPoint(obj.t));v.subVectors(position,prePos);_this.ballOptions.speedX=v.x;_this.ballOptions.speedZ=v.z;prePos.copy(position)},onUpdateParams:[obj],onComplete:callback})};webgl.render=function(){var _this=this;this.clock.startTime=Date.now();if(this.clock.startTime-this.clock.oldTime>50){this.clock.oldTime=this.clock.startTime}if(!this.ballOptions.pause){switch(this.gameState){case"init":break;case"enter":this.ballRender();this.getViewSpeed();break;case"wait":break;case"startFrom0":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();break;case"stage0":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();if(this.ballMesh.position.z<=this.mapData.stage0.g_distance.z){this.gravity.allow=false;this.ballScrollTo((new THREE.Vector3).copy(this.mapData.stage0.g_end),3,function(){_this.gameState=_this.state.waitChose});this.gameState=this.state.slowDown}break;case"stage1":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();if(this.ballMesh.position.z<=this.mapData.stage1.g_distance.z){this.gravity.allow=false;this.ballScrollTo((new THREE.Vector3).copy(this.mapData.stage1.g_end),3,function(){_this.gameState=_this.state.waitChose});this.gameState=this.state.slowDown}this.testStone();break;case"slowDown":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();break;case"stage2":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();if(this.ballMesh.position.z<=this.mapData.stage2.g_distance.z){this.gravity.allow=false;this.ballScrollTo((new THREE.Vector3).copy(this.mapData.stage2.g_end),3,function(){_this.gameState=_this.state.waitChose});this.gameState=this.state.slowDown}this.testStone();break;case"stage3":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();if(this.ballMesh.position.z<=this.mapData.stage3.g_distance.z){this.gravity.allow=false;this.ballScrollTo((new THREE.Vector3).copy(this.mapData.stage3.g_end),3,function(){_this.gameState=_this.state.waitChose});this.gameState=this.state.slowDown}break;case"stage4":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();if(this.ballMesh.position.z<=this.mapData.stage4.g_distance.z){this.gravity.allow=false;this.ballScrollTo((new THREE.Vector3).copy(this.mapData.stage4.g_end),3,function(){_this.gameState=_this.state.end});this.gameState=this.state.slowDown}break;case"stage5":break;case"waitChose":break;case"runCurve":this.ballRender();_this.setCameraPositionOnCurve(_this.cameraT);three.camera.lookAt((new THREE.Vector3).addVectors(_this.ballMesh.position,new THREE.Vector3(0,20,0)));break;case"bump":this.ballRender();this.getViewSpeed();this.setCameraFollowBall();break;case"end":console.log("到终点了");main.stopRender();break}}if(this.fps){this.fps.update()}};var main=new function(){this.touch={ScrollObj:undefined,isScroll:false,limitUp:0,limitDown:undefined,overlimit:false,lastX:0,lastY:0,newX:0,newY:0,delta_X:0,delta_Y:0,scrollY:0,touchAllow:true,fingerNumber:0,distance:0,angle:0,delta_angle:0,time:0,offsetTime:0};this.bgm={obj:document.getElementById("bgm"),id:"bgm",isPlay:false,button:$(".music-btn")};this.V={id:"video",currentTime:0,isPlay:false,obj:document.getElementById("video")};this.assetsUrl="assets/";this.picUrl=this.assetsUrl+"images/";this.modelUrl=this.assetsUrl+"models/";this.ImageList=[{url:this.picUrl+"ball.png",group:"ball"},{url:this.picUrl+"testBoy.png",group:"boy"},{url:this.picUrl+"testGirl.jpg",group:"girl"},{url:this.picUrl+"floor.jpg",group:"floor"},{url:this.modelUrl+"bridge.jpg",group:"bridgeSkin"},{url:this.picUrl+"bg.jpg",group:"1"},{url:this.picUrl+"stone.png",group:"stone"},{url:this.picUrl+"stage1/p2_img_1.png",group:"stage1",name:"left_grass",direction:"left"},{url:this.picUrl+"stage1/p2_img_2.png",group:"stage1",name:"right_grass",direction:"left"},{url:this.picUrl+"stage1/p2_img_3.png",group:"stage1",name:"left_build1",direction:"left"},{url:this.picUrl+"stage1/p2_img_4.png",group:"stage1",name:"right_build2",direction:"left"},{url:this.picUrl+"stage1/p2_img_5.png",group:"stage1",name:"left_build2",direction:"left"},{url:this.picUrl+"stage1/p2_img_6.png",group:"stage1",name:"right_build1",direction:"left"},{url:this.picUrl+"stage1/p2_img_7.png",group:"stage1",name:"left_build3",direction:"left"},{url:this.picUrl+"stage1/p2_img_8.png",group:"stage1",name:"left_build4",direction:"left"},{url:this.picUrl+"stage1/scenebg0.jpg",group:"stage1"},{url:this.picUrl+"stage1/p3_img_1.png",group:"stage1",name:"left_build1",direction:"right"},{url:this.picUrl+"stage1/p3_img_3.png",group:"stage1",name:"left_build2",direction:"right"},{url:this.picUrl+"stage1/p3_img_4.png",group:"stage1",name:"left_build3",direction:"right"},{url:this.picUrl+"stage1/p3_img_5.png",group:"stage1",name:"left_cow",direction:"right"},{url:this.picUrl+"stage1/p3_img_2.png",group:"stage1",name:"left_tree1",direction:"right"},{url:this.picUrl+"stage1/p3_img_6.png",group:"stage1",name:"right_build1",direction:"right"},{url:this.picUrl+"stage1/p3_img_7.png",group:"stage1",name:"right_tree1",direction:"right"},{url:this.picUrl+"stage1/p3_img_8.png",group:"stage1",name:"right_build2",direction:"right"},{url:this.picUrl+"stage1/p3_img_9.png",group:"stage1",name:"left_grass",direction:"right"},{url:this.picUrl+"stage1/p3_img_bg.jpg",group:"stage1"},{url:this.picUrl+"stage2/p4_img_1.png",group:"stage2",name:"left_grass",direction:"left"},{url:this.picUrl+"stage2/p4_img_2.png",group:"stage2",name:"right_grass",direction:"left"},{url:this.picUrl+"stage2/p4_img_3.png",group:"stage2",name:"left_people",direction:"left"},{url:this.picUrl+"stage2/p4_img_4.png",group:"stage2",name:"left_build1",direction:"left"},{url:this.picUrl+"stage2/p4_img_5.png",group:"stage2",name:"left_build2",direction:"left"},{url:this.picUrl+"stage2/p4_img_6.png",group:"stage2",name:"right_build1",direction:"left"},{url:this.picUrl+"stage2/p4_img_7.png",group:"stage2",name:"right_build2",direction:"left"},{url:this.picUrl+"stage2/p4_img_8.png",group:"stage2",name:"right_build3",direction:"left"},{url:this.picUrl+"stage2/p4_img_bg.jpg",group:"stage2"},{url:this.picUrl+"stage2/p5_img_1.png",group:"stage2",name:"left_grass",direction:"right"},{url:this.picUrl+"stage2/p5_img_2.png",group:"stage2",name:"left_build1",direction:"right"},{url:this.picUrl+"stage2/p5_img_3.png",group:"stage2",name:"right_build1",direction:"right"},{url:this.picUrl+"stage2/p5_img_4.png",group:"stage2",name:"right_couple",direction:"right"},{url:this.picUrl+"stage2/p5_img_5.png",group:"stage2",name:"left_horse",direction:"right"},{url:this.picUrl+"stage2/p5_img_6.png",group:"stage2",name:"right_build2",direction:"right"},{url:this.picUrl+"stage2/p5_img_bg.jpg",group:"stage2"},{url:this.picUrl+"stage3/p6_img_1.png",group:"stage3",name:"left_grass",direction:"left"},{url:this.picUrl+"stage3/p6_img_2.png",group:"stage3",name:"left_build1",direction:"left"},{url:this.picUrl+"stage3/p6_img_3.png",group:"stage3",name:"right_build1",direction:"left"},{url:this.picUrl+"stage3/p6_img_4.png",group:"stage3",name:"left_couple",direction:"left"},{url:this.picUrl+"stage3/p6_img_5.png",group:"stage3",name:"right_horse",direction:"left"},{url:this.picUrl+"stage3/p7_img_1.png",group:"stage3",name:"left_people",direction:"right"},{url:this.picUrl+"stage3/p7_img_2.png",group:"stage3",name:"right_build1",direction:"right"},{url:this.picUrl+"stage3/p7_img_3.png",group:"stage3",name:"right_build2",direction:"right"},{url:this.picUrl+"stage3/p7_img_4.png",group:"stage3",name:"left_build1",direction:"right"},{url:this.picUrl+"stage3/p7_img_5.png",group:"stage3",name:"left_build2",direction:"right"},{url:this.picUrl+"stage3/p7_img_6.png",group:"stage3",name:"right_build3",direction:"right"},{url:this.picUrl+"phone.png",group:"1"},{url:this.picUrl+"weile.png",group:"1"}];this.ImageResult={};this.RAF=undefined};main.init=function(){three.init();webgl.init()};main.start=function(){var loader=new Utils.ImageLoader;var _this=this;loader.load(this.ImageList,function(percent){console.log(percent)},function(result){var t;t=new THREE.Texture(result["boy"][0]);t.needsUpdate=true;webgl.ballOptions.texture[0]=t;t=new THREE.Texture(result["girl"][0]);t.needsUpdate=true;webgl.ballOptions.texture[1]=t;t=new THREE.Texture(result["stone"][0]);t.needsUpdate=true;webgl.mapData.stoneTexture=t;for(var i=1;i<4;i++){var stage="stage"+i;var imgGroup=result[stage];var gl=imgGroup.length;for(var g=0;g<gl;g++){var dir=imgGroup[g].direction;if(dir){var name=imgGroup[g].name;var t=new THREE.Texture(imgGroup[g]);t.needsUpdate=true;webgl.mapData[stage][dir][name].texture=t}}}_this.ImageResult=result;_this.loadCallBack()
;webgl.loadCallback()})};main.loadCallBack=function(){this.startRender();setTimeout(function(){vm.ploading.visible=false;vm.p1.visible=true;window.removeEventListener("orientationchange",onOrientChange1);window.addEventListener("orientationchange",onOrientChange2);onOrientChange2()},1e3)};main.prule=function(){$(".P_rule").fi();main.scrollInit(".rule-txt",0)};main.prulelaeve=function(){$(".P_rule").fo(function(){$(".rule-txt")[0].style.webkitTransform="translate3d(0,0,0)"})};main.scrollInit=function(selector){this.touch.ScrollObj=$(selector);this.touch.container=$(selector).parent();this.touch.StartY=0;this.touch.NewY=0;this.touch.addY=0;this.touch.scrollY=0;this.touch.limitDown=this.touch.ScrollObj.height()<this.touch.container.height()?0:this.touch.container.height()-this.touch.ScrollObj.height()};main.limitNum=function(obj){var value=obj.value;var length=value.length;if(length>11){value=value.substring(0,11);obj.value=value}};main.playbgm=function(){Media.playMedia(this.bgm.id);this.bgm.button.addClass("ani-bgmRotate");this.bgm.isPlay=true};main.pausebgm=function(){this.bgm.obj.pause();this.bgm.button.removeClass("ani-bgmRotate");this.bgm.isPlay=false};main.startRender=function(){var loop=function(){three.render();webgl.render();main.RAF=window.requestAnimationFrame(loop)};loop()};main.stopRender=function(){window.cancelAnimationFrame(main.RAF)};main.addEvent=function(){document.body.ontouchmove=function(e){e.preventDefault()};window.addEventListener("orientationchange",onOrientChange1);setTimeout(function(){onOrientChange1()},500);window.onresize=function(){three.onresize()}};function onOrientChange1(e){if(window.orientation==0||window.orientation==180){vm.hpwarn.visible=false}else if(window.orientation==90||window.orientation==-90){vm.hpwarn.visible=true}}function onOrientChange2(e){setTimeout(function(){if(window.orientation==0||window.orientation==180){$(".sp").fi();webgl.gravity.orient=0}else if(window.orientation==90||window.orientation==-90){$(".sp").fo();webgl.gravity.orient=window.orientation/90}},0)}$(function(){main.addEvent();main.init();main.start()});